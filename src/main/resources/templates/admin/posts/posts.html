<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت پست‌ها - سینا بلاگ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<script src="/js/app.js"></script>
<!-- Header -->
<div th:replace="fragments/header :: header"></div>
<div class="container-fluid">
    <div class="row">
        <main class="col-md-12 px-md-4">
            <div class="d-sm-flex align-items-center justify-content-between mb-4 pt-3">
                <h1 class="h3 mb-0 text-gray-800">مدیریت پست‌ها</h1>
                <button class="btn btn-sm btn-primary shadow-sm" id="addPostBtn">
                    <i class="fas fa-plus fa-sm text-white-50"></i> پست جدید
                </button>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">لیست پست‌ها</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" placeholder="جستجوی پست..." id="postSearch">
                        </div>
                        <div class="col-md-3">
                            <select class="form-control" id="categoryFilter">
                                <option value="">همه دسته‌بندی‌ها</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-control" id="statusFilter">
                                <option value="">همه وضعیت‌ها</option>
                                <option value="PUBLISHED">منتشر شده</option>
                                <option value="DRAFT">پیش‌نویس</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" id="filterBtn">فیلتر</button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered" id="postsTable">
                            <thead>
                            <tr>
                                <th>عنوان</th>
                                <th>دسته‌بندی</th>
                                <th>نویسنده</th>
                                <th>تاریخ ایجاد</th>
                                <th> اتاریخ انتشار</th>
                                <th>بازدید</th>
                                <th>وضعیت</th>
                                <th>عملیات</th>
                            </tr>
                            </thead>
                            <tbody id="postsBody">
                            <!-- ردیف‌های پست‌ها از طریق JS بارگذاری می‌شوند -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    const apiBase = '/api/posts';

    async function fetchCategories() {
        // فرض می‌کنیم API برای دریافت دسته‌بندی‌ها موجود است
        // const res = await fetch('/api/categories');
        // const categories = await res.json();
        const categories = [
            {id: 1, name: 'برنامه‌نویسی'},
            {id: 2, name: 'وب'},
            {id: 3, name: 'پایتون'}
        ];
        const select = document.getElementById('categoryFilter');
        categories.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat.id;
            opt.textContent = cat.name;
            select.appendChild(opt);
        });
    }

    async function fetchPosts() {
        const keyword = document.getElementById('postSearch').value;
        const categoryId = document.getElementById('categoryFilter').value;
        const status = document.getElementById('statusFilter').value;
        let url = `${apiBase}?`;

        if (keyword) url += `keyword=${keyword}&`;
        if (categoryId) url += `categoryId=${categoryId}&`;
        if (status) url += `status=${status}&`;

        const res = await fetch(url);
        const posts = await res.json();
        renderPosts(posts);
    }

    function renderPosts(posts) {
        const tbody = document.getElementById('postsBody');
        tbody.innerHTML = '';
        posts.forEach(post => {
            const tr = document.createElement('tr');

            tr.innerHTML = `
            <td>${post.title}</td>
            <td>${post.categoryName || ''}</td>
            <td>${post.authorName || ''}</td>
            <td>${post.createdAt ? new Date(post.publishedAt).toLocaleDateString('fa-IR') : ''}</td>
            <td>${post.publishedAt ? new Date(post.publishedAt).toLocaleDateString('fa-IR') : ''}</td>
            <td>${post.views || 0}</td>
            <td>
                <span class="badge ${post.status === 'PUBLISHED' ? 'bg-success' : 'bg-warning'}">
                    ${post.status === 'PUBLISHED' ? 'منتشر شده' : 'پیش‌نویس'}
                </span>
            </td>
            <td>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" onclick="editPost(${post.id})"><i class="fas fa-edit"></i></button>
                    ${post.status === 'PUBLISHED'
                ? `<button class="btn btn-sm btn-outline-warning" onclick="unpublishPost(${post.id})"><i class="fas fa-eye-slash"></i></button>`
                : `<button class="btn btn-sm btn-outline-success" onclick="publishPost(${post.id})"><i class="fas fa-check"></i></button>`
            }
                    <button class="btn btn-sm btn-outline-danger" onclick="deletePost(${post.id})"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        `;
            tbody.appendChild(tr);
        });
    }

    // ================== عملیات ==================
    async function publishPost(id) {
        await fetch(`${apiBase}/${id}/publish`, {method: 'PATCH'});
        fetchPosts();
    }

    async function unpublishPost(id) {
        await fetch(`${apiBase}/${id}/unpublish`, {method: 'PATCH'});
        fetchPosts();
    }

    async function deletePost(id) {
        if (confirm('آیا مطمئن هستید می‌خواهید این پست را حذف کنید؟')) {
            await fetch(`${apiBase}/${id}`, {method: 'DELETE'});
            fetchPosts();
        }
    }

    function editPost(id) {
        window.location.href = `/admin/posts/edit?id=${id}`;
    }

    // ================== لود اولیه ==================
    document.getElementById('filterBtn').addEventListener('click', fetchPosts);
    document.getElementById('addPostBtn').addEventListener('click', () => window.location.href='/admin/posts/new');

    fetchCategories();
    fetchPosts();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
