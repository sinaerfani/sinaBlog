<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت دسته‌بندی‌ها - سینا بلاگ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<div th:replace="fragments/header :: header"></div>
<div class="container-fluid">
<!--    <div class="row">-->
<!--        <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">-->
<!--            <div th:replace="fragments/sidebar :: sidebar"></div>-->
<!--        </nav>-->

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-sm-flex align-items-center justify-content-between mb-4 pt-3">
                <h1 class="h3 mb-0 text-gray-800">مدیریت دسته‌بندی‌ها</h1>
                <button class="btn btn-sm btn-primary shadow-sm" onclick="openAddModal()">
                    <i class="fas fa-plus fa-sm text-white-50"></i> دسته‌بندی جدید
                </button>
            </div>

            <div class="row">
                <!-- لیست دسته‌بندی‌ها -->
                <div class="col-lg-8">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">لیست دسته‌بندی‌ها</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered text-center">
                                    <thead>
                                    <tr>
                                        <th>نام</th>
                                        <th>Slug</th>
                                        <th>توضیحات</th>
                                        <th>عملیات</th>
                                    </tr>
                                    </thead>
                                    <tbody id="categoryTableBody">
                                    <!-- پر میشه با جاوااسکریپت -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- آمار دسته‌بندی‌ها -->
                <div class="col-lg-4">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">آمار دسته‌بندی‌ها</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- مودال افزودن/ویرایش -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="categoryForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">افزودن دسته‌بندی</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="categoryId">
                    <div class="mb-3">
                        <label class="form-label">نام دسته‌بندی</label>
                        <input type="text" id="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Slug</label>
                        <input type="text" id="slug" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">توضیحات</label>
                        <textarea id="description" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn btn-primary">ذخیره</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div th:replace="fragments/footer :: footer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));
    const tableBody = document.getElementById("categoryTableBody");
    const form = document.getElementById("categoryForm");
    let editingId = null;

    async function loadCategories() {
        const res = await fetch("/api/categories");
        const data = await res.json();

        tableBody.innerHTML = "";
        data.forEach(cat => {
            tableBody.innerHTML += `
                <tr>
                    <td>${cat.name}</td>
                    <td>${cat.slug}</td>
                    <td>${cat.description || "-"}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editCategory(${cat.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${cat.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        });

        loadChart();
    }

    function openAddModal() {
        editingId = null;
        form.reset();
        document.getElementById("modalTitle").innerText = "افزودن دسته‌بندی";
        categoryModal.show();
    }

    async function editCategory(id) {
        const res = await fetch(`/api/categories/${id}`);
        const cat = await res.json();
        editingId = id;

        document.getElementById("name").value = cat.name;
        document.getElementById("slug").value = cat.slug;
        document.getElementById("description").value = cat.description || "";

        document.getElementById("modalTitle").innerText = "ویرایش دسته‌بندی";
        categoryModal.show();
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const payload = {
            name: document.getElementById("name").value,
            slug: document.getElementById("slug").value,
            description: document.getElementById("description").value
        };

        let url = "/api/categories";
        let method = "POST";

        if (editingId) {
            url = `/api/categories/${editingId}`;
            method = "PUT";
        }

        await fetch(url, {
            method,
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        });

        categoryModal.hide();
        loadCategories();
    });

    async function deleteCategory(id) {
        if (!confirm("آیا مطمئن هستید؟")) return;
        await fetch(`/api/categories/${id}`, {method: "DELETE"});
        loadCategories();
    }

    async function loadChart() {
        const activeRes = await fetch("/api/categories/count/active");
        const deletedRes = await fetch("/api/categories/count/deleted");

        const activeCount = await activeRes.json();
        const deletedCount = await deletedRes.json();

        new Chart(document.getElementById("categoryChart"), {
            type: 'pie',
            data: {
                labels: ["فعال", "حذف‌شده"],
                datasets: [{
                    data: [activeCount, deletedCount],
                    backgroundColor: ['#1cc88a', '#e74a3b']
                }]
            }
        });
    }

    loadCategories();
</script>
</body>
</html>
