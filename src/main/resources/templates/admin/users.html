<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت کاربران - سینا بلاگ</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Custom CSS -->
    <link href="/static/css/admin.css" rel="stylesheet">
</head>
<body>
<script src="/js/app.js"></script>

<!-- Header -->
<div th:replace="fragments/header :: header"></div>
<div class="container-fluid">
    <div class="row">


        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between align-items-center pt-3 mb-4">
                <h1 class="h3">مدیریت کاربران</h1>
                <button class="btn btn-primary" onclick="openAddUserModal()">
                    <i class="fas fa-user-plus"></i> افزودن کاربر جدید
                </button>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="m-0">لیست کاربران</h6>
                    <div class="spinner-border spinner-border-sm text-primary" id="loadingSpinner" style="display:none"></div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" id="userSearch" class="form-control" placeholder="جستجو...">
                                <button class="btn btn-primary" onclick="searchUsers()"><i class="fas fa-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select class="form-control" id="roleFilter" onchange="searchUsers()">
                                <option value="">همه نقش‌ها</option>
                                <option value="ROLE_ADMIN">مدیر</option>
                                <option value="ROLE_USER">کاربر عادی</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" onclick="loadUsers()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered" id="usersTable">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th>نام کاربری</th>
                                <th>ایمیل</th>
                                <th>نام کامل</th>
                                <th>نقش</th>
                                <th>تاریخ عضویت</th>
                                <th>وضعیت</th>
                                <th>عملیات</th>
                            </tr>
                            </thead>
                            <tbody id="usersTableBody">
                            <tr id="loadingRow">
                                <td colspan="8" class="text-center">
                                    <div class="spinner-border text-primary"></div>
                                    <p>در حال بارگذاری...</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <nav id="paginationContainer" style="display:none;">
                        <ul class="pagination justify-content-center" id="pagination"></ul>
                    </nav>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- مودال افزودن/ویرایش کاربر -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">افزودن کاربر جدید</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="mb-3">
                        <label>نام کاربری *</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label>ایمیل *</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label>نام کامل</label>
                        <input type="text" class="form-control" id="fullName">
                    </div>
                    <div class="mb-3">
                        <label>نقش *</label>
                        <select class="form-control" id="role" required>
                            <option value="">انتخاب کنید</option>
                            <option value="ROLE_USER">کاربر عادی</option>
                            <option value="ROLE_ADMIN">مدیر</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>گذرواژه <span id="passwordRequired">*</span></label>
                        <input type="password" class="form-control" id="password">
                        <small class="text-muted" id="passwordHelp">برای کاربر جدید الزامی است</small>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="enabled">
                        <label class="form-check-label">فعال</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                <button class="btn btn-primary" onclick="saveUser()">ذخیره</button>
            </div>
        </div>
        <!-- Sidebar -->
        <div class="col-lg-4">
            <div th:replace="fragments/sidebar :: sidebar"></div>
        </div>
    </div>
</div>


<!-- Footer -->
<div th:replace="fragments/footer :: footer"></div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let allUsers = [];
    let currentPage = 0;
    let totalPages = 1;

    // بررسی دسترسی ادمین
    document.addEventListener('DOMContentLoaded', () => { checkAdminAccess(); });

    async function checkAdminAccess() {
        try {
            const resp = await fetch('/api/auth/current-user', { credentials: 'include' });

            if (!resp.ok) {
                window.location.href = '/auth/login';
                return;
            }

            const user = await resp.json();

            if (user.role !== 'ROLE_ADMIN') {
                window.location.href = '/access-denied';
                return;
            }

            loadUsers();
        } catch (e) {
            console.error(e);
            window.location.href = '/auth/login';
        }
    }

    async function loadUsers(page=0, size=10){
        showLoading(true);
        try{
            const resp = await fetch(`/api/users?page=${page}&size=${size}`, { credentials:'include' });
            const data = await resp.json();
            allUsers = data.content || data;
            currentPage = data.number || 0;
            totalPages = data.totalPages || 1;
            renderUsersTable();
            renderPagination();
        } catch(e){ console.error(e); alert('خطا در بارگذاری کاربران'); }
        finally{ showLoading(false); }
    }

    function renderUsersTable(){
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';
        if(allUsers.length===0){
            tbody.innerHTML='<tr><td colspan="8" class="text-center">هیچ کاربری یافت نشد</td></tr>';
            return;
        }
        allUsers.forEach((u,i)=>{
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${(currentPage*10)+i+1}</td>
            <td>${u.username}</td>
            <td>${u.email}</td>
            <td>${u.fullName||'-'}</td>
            <td><span class="badge ${u.role==='ROLE_ADMIN'?'bg-danger':'bg-secondary'}">
                ${u.role==='ROLE_ADMIN'?'مدیر':'کاربر عادی'}</span></td>
            <td>${formatDate(u.createdAt)}</td>
            <td><span class="badge ${u.enabled?'bg-success':'bg-danger'}">
                ${u.enabled?'فعال':'غیرفعال'}</span></td>
            <td>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" onclick="editUser(${u.id})"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-warning" onclick="toggleUserStatus(${u.id},${!u.enabled})">
                        <i class="fas ${u.enabled?'fa-user-slash':'fa-user-check'}"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        `;
            tbody.appendChild(row);
        });
    }

    function renderPagination(){
        const container = document.getElementById('paginationContainer');
        const pagination = document.getElementById('pagination');
        if(totalPages<=1){ container.style.display='none'; return; }
        container.style.display='block';
        pagination.innerHTML='';
        const prevLi = document.createElement('li');
        prevLi.className=`page-item ${currentPage===0?'disabled':''}`;
        prevLi.innerHTML=`<a class="page-link" href="#" onclick="changePage(${currentPage-1})">قبلی</a>`;
        pagination.appendChild(prevLi);
        for(let i=0;i<totalPages;i++){
            const li = document.createElement('li');
            li.className=`page-item ${i===currentPage?'active':''}`;
            li.innerHTML=`<a class="page-link" href="#" onclick="changePage(${i})">${i+1}</a>`;
            pagination.appendChild(li);
        }
        const nextLi = document.createElement('li');
        nextLi.className=`page-item ${currentPage===totalPages-1?'disabled':''}`;
        nextLi.innerHTML=`<a class="page-link" href="#" onclick="changePage(${currentPage+1})">بعدی</a>`;
        pagination.appendChild(nextLi);
    }

    function changePage(p){ if(p>=0 && p<totalPages) loadUsers(p); }
    function formatDate(d){ if(!d) return '-'; return new Date(d).toLocaleDateString('fa-IR'); }
    function showLoading(show){ document.getElementById('loadingSpinner').style.display=show?'inline-block':'none'; }

    function openAddUserModal(){
        document.getElementById('modalTitle').textContent='افزودن کاربر جدید';
        document.getElementById('userForm').reset();
        document.getElementById('userId').value='';
        document.getElementById('passwordRequired').style.display='inline';
        document.getElementById('password').required=true;
        const modal = new bootstrap.Modal(document.getElementById('userModal'));
        modal.show();
    }

    async function editUser(id){
        const resp = await fetch(`/api/users/${id}`, {credentials:'include'});
        const u = await resp.json();
        document.getElementById('modalTitle').textContent='ویرایش کاربر';
        document.getElementById('userId').value=u.id;
        document.getElementById('username').value=u.username;
        document.getElementById('email').value=u.email;
        document.getElementById('fullName').value=u.fullName||'';
        document.getElementById('role').value=u.role;
        document.getElementById('enabled').checked=u.enabled;
        document.getElementById('passwordRequired').style.display='none';
        document.getElementById('password').required=false;
        const modal = new bootstrap.Modal(document.getElementById('userModal'));
        modal.show();
    }

    async function saveUser(){
        const data = {
            id: document.getElementById('userId').value||null,
            username: document.getElementById('username').value,
            email: document.getElementById('email').value,
            fullName: document.getElementById('fullName').value,
            role: document.getElementById('role').value,
            password: document.getElementById('password').value,
            enabled: document.getElementById('enabled').checked
        };
        if(!data.username || !data.email || !data.role){ alert('پر کردن فیلدهای ستاره‌دار الزامی است'); return; }
        if(!data.id && !data.password){ alert('برای کاربر جدید گذرواژه الزامی است'); return; }

        const url = data.id?`/api/users/${data.id}`:'/api/users';
        const method = data.id?'PUT':'POST';
        try{
            const resp = await fetch(url, { method, headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify(data) });
            if(resp.ok){
                bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                alert('عملیات با موفقیت انجام شد');
                loadUsers(currentPage);
            } else{
                const err = await resp.json();
                alert('❌ '+(err.message||'خطا در ذخیره کاربر'));
            }
        } catch(e){ console.error(e); alert('❌ '+e.message); }
    }

    async function toggleUserStatus(id, enabled){
        if(!confirm(`آیا مطمئن هستید که می‌خواهید این کاربر را ${enabled?'فعال':'غیرفعال'} کنید؟`)) return;
        await fetch(`/api/users/${id}/status?enabled=${enabled}`, {method:'PATCH', credentials:'include'});
        loadUsers(currentPage);
    }

    async function deleteUser(id){
        if(!confirm('آیا مطمئن هستید که می‌خواهید این کاربر را حذف کنید؟')) return;
        await fetch(`/api/users/${id}`, {method:'DELETE', credentials:'include'});
        loadUsers(currentPage);
    }

    async function searchUsers(){
        const query = document.getElementById('userSearch').value;
        const role = document.getElementById('roleFilter').value;
        showLoading(true);
        let url = `/api/users?page=0&size=100`;
        const resp = await fetch(url, {credentials:'include'});
        const data = await resp.json();
        allUsers = data.content.filter(u=>{
            const matchRole = role?u.role===role:true;
            const matchQuery = query?u.username.includes(query)||u.fullName?.includes(query):true;
            return matchRole && matchQuery;
        });
        currentPage = 0;
        totalPages = 1;
        renderUsersTable();
        document.getElementById('paginationContainer').style.display='none';
        showLoading(false);
    }
</script>
</body>
</html>
